# CDN了解

## 认识CDN

### 概念和产生背景

内容分发网络/内容交付网络.

互联网和万维网的区分:

- 互联网以tcp/ip为核心的网络层,是网络的基础
- 万维网www以应用为代表的应用层,是互联网中最粗的一个枝条

内容提供商sp(service provider)提供服务,用户来消费.
整个过程的优化只能发生在应用程,优化互联网很难.
目前网络传输存在4个易堵地方:

- 第一公里:sp接入互联网的带宽
- 最后一公里:用户接入互联网的带宽(现阶段4G/5G已解决这部分的瓶颈)
- 对等互联网关:不同运营商的互联互通,这是跨网问题(BGP机房少)
- 长途骨干传输:IDC/骨干网/用户城域网/用户接入网

### CDN的基本工作过程

传统访问url的过程:

- 用户将url丢给dns服务器,获取具体的ip地址
- 用户去具体的ip地址(sp)访问,获取内容

使用cdn访问url的过程:

- 用户将url丢给本地dns系统,dns会用cname记录转给cdn专用dns服务器
- cdn的dns将cdn的全局负载均衡设备ip返回给用户
- 用户将url丢给全局负载均衡设备, 设备会返回一个具体的缓存服务器
- 用户将url丢给缓存服务器,如果有,直接返回,如果没有,缓存服务器就去源站拉去数据

全局复杂均衡设备会判断用户ip(就近),
会判断url(看哪台缓存服务器有内容),
会判断各缓存服务器的负载(均衡).

## CDN技术概述

cdn的原理:

- 挑选最优设备为用户服务
- 如果某个内容被很多用户需要,将缓存到离用户最近的节点

前一点的最优是负载均衡,后一点是就近接入,为的是快速响应.

cdn的缓存服务节点很多,一般会部署在idc(因为离用户近).

### 功能架构

功能上分3块:

- 分发服务系统
	- 主要作用:源站内容推送到边缘站,并存储
	- 边缘站还负责与源站同步
	- 依据内容类型和服务种类,包含以下子服务系统
		- 网页加速子系统
		- 流媒体加速子系统
		- 应用加速子系统
		- 每个子系统都是一个独立分布式集群
- 负载均衡系统
	- 访问调度中枢,告诉用户最终的访问地址
- 运营管理系统
	- 有两个子系统,运营管理和网络管理
	- 运营管理是业务管理功能的实体
		- 负载业务层和外界的交互
		- 包括以下子系统
			- 客户管理
			- 产品管理
			- 计费管理
			- 统计分析
	- 网络管理对cdn网络资源管理/拓扑管理/链路监控/故障管理

分发服务系统,需要更新/同步内容/响应用户需求,
同时还需向上层调度控制系统提供每个缓存节点的健康状况/
响应情况以及内容分布情况,上层调度控制系统会根据这些信息计算"最优".

负载均衡系统,一般是分级实现,最简单的是两级:
gslb全局负载均衡/slb本地负载均衡.

gslb主要考虑"就近",通过dns或应用层重定向实现.
slb主要考虑"设备负载均衡",
当用户请求从gslb调度到slb时,会依据缓存节点的负载对用户进行重定向,
常用的实现有4层调度/7层调度/链路负载调度.

### 部署架构

cdn系统的第一目的:快速响应(减少用户访问时间).
离用户最近的缓存节点部署在网络的边缘位置,称边缘层.
对应的有中心层,中心层负载全局性管理和控制的设备组成,
中心层的缓存内容最多,如果边缘站未命中,会去中心站请求,
中心站也未命中,就会去源站请求(这个叫回源).

cdn越庞大,那么中心层和边缘层之间还可以加层,负载一个区域的管理和控制.

一般cdn的部署分3层.节点是最基本的部署单元,
这些节点数量巨大,地理位置分散.边缘节点称为pop点,
中心层和区域节点称为骨干点.
pop(point of persence)面向用户提供服务的节点.

一个节点包中可包含缓存设备和本地负载均衡设备slb,
缓存设备和负载均衡设备有两种连接方式:

- 穿越
	- slb有l4-7交换机实现
	- slb充当nat,屏蔽缓存设备的ip
	- 缺点是节点容量大时,l4-7容易成为瓶颈
- 旁路
	- 并联模式,缺点是安全性不够
	- 这种模式下,slb和cache是同等级的
		- 用户先访问slb,再访问cache

### cdn系统的分类

基于内容类型

- 静态网页 - 网页加速
- 动态网页 - 网页加速
- 流媒体 - 流媒体加速
	- 流媒体直播加速(p2p技术就是这种业务下的产物)
	- 流媒体点播加速
- 下载型文件 - 文件传输加速(http/ftp/p2p下载)
- 应用协议 - 应用协议加速
	- 针对tpc/ip传输协议优化,或是针对特殊协议
	- 广域网应用加速
	- ssl应用加速
	- 网页压缩

基于内容生成机制和分层(这点后续详细说到)

### 小结

cdn的三维模型:

- x, 业务类型(web/流媒体/p2p)
- y, 网页分级(中心/区域/边缘)
- z, 数据平面/管理平面/控制平面

## 内容缓存工作原理和实现

cache是基础技术和组成单元.

### cache技术的发展背景

随着用户的增长,在服务端做扩展,做集群,这些无法解决网页延时,
也无法解决"最后一公里"等网络问题,也就出现了cache技术.

先看下用户增长时,常见的问题:

- 无法及时满足并发用户增长的需求
	- 常规解决:集群
- 集群后,较远用户体验不佳
	- 常规解决:部署多个镜像
- 部署镜像后,中心和镜像同步不及时,无法智能故障迁移,成本高,易受攻击

在cdn之前,这些常规解决方案的技术如下

- 扩展 scale
	- scale up, 提升服务器性能
	- scale out, 服务器集群
- 镜像 mirroring
	- 自动备份,常用于解决跨网问题
- 缓存 cache
	- 基于缓存技术的主要应用方式有缓存代理和cdn

### cache设备的工作方式和设计要求

设备厂商研发cache设备时,不会区分web cache设备和流媒体cache设备,
但cdn服务运营提供商会区分,因为优化技术路线不同,
cdn服务提供商会推出两个独立产品.

下面只涉及web cache,流媒体cache在之后讲到.

用户的一次网页访问,会涉及4个网元:

- 用户
- 代理
- 网关
- web服务器

http规定,客户端,用户浏览器已缓存了,用户再次访问可直接使用缓存,
所以web cache一般放在代理或网关上.

web cache作为代理时,工作模式时正向代理或透明代理;
web cache放在网关是,工作模式是反向代理,这种模式也是cdn应用场景,
也是web cache应用最多的场景.

### 正向代理/反向代理/透明代理

正向代理 forward proxy:

- 用户主机和代理服务器部署在同一网络环境
- 如果代理有用户请求的缓存,就直接返回
- 多用于中小企业网络环境
	- 除了缓存,还可以提供安全认证/访问控制
- 用户主机需要配置正向代理服务

反向代理 backward proxy:

- 用户不需要配置代理服务器地址
- cache设备会写入dns记录,利用cache设备的内容路由/交互能力完成代理访问
- 多用于大型isp/icp和运营商环境
- 当cache较多时,需要部署gslb 全部负载均衡 (这也是cdn的雏形)
- 代理服务器cache和应用服务部署在同已网络环境
- 反向代理提供负载分担和安全隔离作用

idc/icp/isp区分:

- icp (internet content provider),网页内容服务商
	- 各个提供服务的公司,eg:提供网站服务的公司
- idc (internet data center),网络数据中心
	- 为icp提供托管/租用服务,常称为机房
- isp (Internetservice provider), 互联网服务提供商
	- 为网络最终用户提供接入,eg:电信 移动 联通

透明代理 transparent proxy:

- 用户浏览器不需要配置代理服务器
- 用户路由设备需要支持wccp协议(web cache control protocol)
- 不用wccp协议,也可以L4层将用户流量转给cache
- 部署和正向代理类似,但用户主机不需要配置代理服务

透明代理可以看作是通过"网络设备/协议"实现的正向代理.

实现一个web cache的关键点:

- http基本功能
- 具体应用场景和工作模式下,需要达到不同的性能指标